{% extends 'admin_dashboard/base.html' %}

{% block content %}
<!-- Page Header -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="h3 mb-0">Product Management</h2>
    <button class="btn btn-coffee" data-bs-toggle="modal" data-bs-target="#addProductModal">
        <i class="bi bi-plus-circle me-2"></i>Add New Product
    </button>
</div>

<!-- Filters and Search -->
<div class="card mb-4">
    <div class="card-body">
        <div class="row g-3">
            <div class="col-md-4">
                <label for="searchProduct" class="form-label">Search Products</label>
                <input type="text" class="form-control" id="searchProduct" placeholder="Search by name...">
            </div>
            <div class="col-md-3">
                <label for="categoryFilter" class="form-label">Category</label>
                <select class="form-select" id="categoryFilter">
                    <option value="">All Categories</option>
                </select>
            </div>
            <div class="col-md-3">
                <label for="stockFilter" class="form-label">Stock Status</label>
                <select class="form-select" id="stockFilter">
                    <option value="">All Stock Levels</option>
                    <option value="in_stock">In Stock</option>
                    <option value="low_stock">Low Stock</option>
                    <option value="out_of_stock">Out of Stock</option>
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">&nbsp;</label>
                <button class="btn btn-outline-primary d-block w-100" onclick="applyFilters()">
                    <i class="bi bi-funnel me-1"></i>Filter
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Products Table -->
<div class="card">
    <div class="card-header">
        <h6 class="m-0 fw-bold text-primary">All Products</h6>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover" id="productsTable">
                <thead>
                    <tr>
                        <th>Image</th>
                        <th>Name</th>
                        <th>Category</th>
                        <th>Price</th>
                        <th>Stock</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="productsTableBody">
                    <tr>
                        <td colspan="7" class="text-center">
                            <div class="loading">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Add Product Modal -->
<div class="modal fade" id="addProductModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Product</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="addProductForm" enctype="multipart/form-data">
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-12">
                            <label for="productName" class="form-label">Product Name *</label>
                            <input type="text" class="form-control" id="productName" name="name" required>
                        </div>
                        
                        <div class="col-md-6">
                            <label for="productCategory" class="form-label">Category *</label>
                            <select class="form-select" id="productCategory" name="category" required>
                                <option value="">Select Category</option>
                            </select>
                        </div>
                        
                        <div class="col-md-6">
                            <label for="productPrice" class="form-label">Price (₹) *</label>
                            <input type="number" class="form-control" id="productPrice" name="price" step="0.01" min="0" required>
                        </div>
                        
                        <div class="col-md-6">
                            <label for="productStock" class="form-label">Stock Quantity *</label>
                            <input type="number" class="form-control" id="productStock" name="stock" min="0" required>
                        </div>
                        
                        <div class="col-md-6">
                            <label for="productImage" class="form-label">Product Image</label>
                            <input type="file" class="form-control" id="productImage" name="image" accept="image/*">
                        </div>
                        
                        <div class="col-12">
                            <label for="productDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="productDescription" name="description" rows="3"></textarea>
                        </div>
                        
                        <div class="col-12">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="productActive" name="is_available" checked>
                                <label class="form-check-label" for="productActive">
                                    Active (Available for customers)
                                </label>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="productFeatured" name="is_featured">
                                <label class="form-check-label" for="productFeatured">
                                    Featured Product
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-coffee">Add Product</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Product Modal -->
<div class="modal fade" id="editProductModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Product</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editProductForm" enctype="multipart/form-data">
                <input type="hidden" id="editProductId" name="id">
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-12">
                            <label for="editProductName" class="form-label">Product Name *</label>
                            <input type="text" class="form-control" id="editProductName" name="name" required>
                        </div>
                        
                        <div class="col-md-6">
                            <label for="editProductCategory" class="form-label">Category *</label>
                            <select class="form-select" id="editProductCategory" name="category" required>
                                <option value="">Select Category</option>
                            </select>
                        </div>
                        
                        <div class="col-md-6">
                            <label for="editProductPrice" class="form-label">Price (₹) *</label>
                            <input type="number" class="form-control" id="editProductPrice" name="price" step="0.01" min="0" required>
                        </div>
                        
                        <div class="col-md-6">
                            <label for="editProductStock" class="form-label">Stock Quantity *</label>
                            <input type="number" class="form-control" id="editProductStock" name="stock" min="0" required>
                        </div>
                        
                        <div class="col-md-6">
                            <label for="editProductImage" class="form-label">Product Image</label>
                            <input type="file" class="form-control" id="editProductImage" name="image" accept="image/*">
                            <small class="text-muted">Leave empty to keep current image</small>
                        </div>
                        
                        <div class="col-12">
                            <label for="editProductDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="editProductDescription" name="description" rows="3"></textarea>
                        </div>
                        
                        <div class="col-12">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="editProductActive" name="is_available">
                                <label class="form-check-label" for="editProductActive">
                                    Active (Available for customers)
                                </label>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="editProductFeatured" name="is_featured">
                                <label class="form-check-label" for="editProductFeatured">
                                    Featured Product
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-coffee">Update Product</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteProductModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this product? This action cannot be undone.</p>
                <div class="alert alert-warning">
                    <strong>Product:</strong> <span id="deleteProductName"></span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete Product</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let currentProducts = [];
    let categories = [];
    
    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
        loadCategories();
        loadProducts();
        setupEventListeners();
    });
    
    function loadCategories() {
        fetch('/api/admin/categories/')
            .then(response => response.json())
            .then(data => {
                categories = data;
                populateCategorySelects();
            })
            .catch(error => {
                console.error('Error loading categories:', error);
            });
    }
    
    function populateCategorySelects() {
        const selects = ['categoryFilter', 'productCategory', 'editProductCategory'];
        
        selects.forEach(selectId => {
            const select = document.getElementById(selectId);
            // Clear all options except for categoryFilter which keeps "All Categories"
            if (selectId !== 'categoryFilter') {
                select.innerHTML = '<option value="">Select Category</option>';
            } else {
                // For categoryFilter, keep the "All Categories" option and add categories after it
                const firstOption = select.innerHTML; // This contains "All Categories"
                select.innerHTML = firstOption;
            }
            
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = category.name;
                select.appendChild(option);
            });
        });
    }
    
    function loadProducts() {
        fetch('/api/admin/products/')
            .then(response => response.json())
            .then(data => {
                currentProducts = data;
                displayProducts(data);
            })
            .catch(error => {
                console.error('Error loading products:', error);
                showToast('Error loading products', 'error');
            });
    }
    
    function displayProducts(products) {
        const tbody = document.getElementById('productsTableBody');
        
        if (products.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No products found</td></tr>';
            return;
        }
        
        tbody.innerHTML = products.map(product => `
            <tr>
                <td>
                    ${product.image ? 
                        `<img src="${product.image}" alt="${product.name}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 0.25rem;">` : 
                        '<div class="bg-light d-flex align-items-center justify-content-center" style="width: 50px; height: 50px; border-radius: 0.25rem;"><i class="bi bi-image text-muted"></i></div>'
                    }
                </td>
                <td>
                    <strong>${product.name}</strong>
                    ${product.description ? `<br><small class="text-muted">${product.description.substring(0, 50)}${product.description.length > 50 ? '...' : ''}</small>` : ''}
                </td>
                <td>${product.category_name || 'No Category'}</td>
                <td>₹${Number(product.price).toLocaleString('en-IN')}</td>
                <td>
                    <span class="badge bg-${getStockColor(product.stock)}">
                        ${product.stock} units
                    </span>
                </td>
                <td>
                    <span class="badge bg-${product.is_available ? 'success' : 'secondary'}">
                        ${product.is_available ? 'Active' : 'Inactive'}
                    </span>
                    ${product.is_featured ? '<span class="badge bg-warning ms-1">Featured</span>' : ''}
                </td>
                <td>
                    <div class="btn-group" role="group">
                        <button class="btn btn-sm btn-outline-primary" onclick="editProduct(${product.id})" title="Edit">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="confirmDeleteProduct(${product.id}, '${product.name.replace(/'/g, "\\'")}')" title="Delete">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `).join('');
    }
    
    function getStockColor(stock) {
        if (stock === 0) return 'danger';
        if (stock <= 5) return 'warning';
        return 'success';
    }
    
    function setupEventListeners() {
        // Search functionality
        document.getElementById('searchProduct').addEventListener('input', applyFilters);
        
        // Form submissions
        document.getElementById('addProductForm').addEventListener('submit', handleAddProduct);
        document.getElementById('editProductForm').addEventListener('submit', handleEditProduct);
        document.getElementById('confirmDeleteBtn').addEventListener('click', handleDeleteProduct);
    }
    
    function applyFilters() {
        const searchTerm = document.getElementById('searchProduct').value.toLowerCase();
        const categoryFilter = document.getElementById('categoryFilter').value;
        const stockFilter = document.getElementById('stockFilter').value;
        
        let filteredProducts = currentProducts.filter(product => {
            const matchesSearch = product.name.toLowerCase().includes(searchTerm) ||
                                (product.description && product.description.toLowerCase().includes(searchTerm));
            
            // Use category_obj for filtering instead of category
            const matchesCategory = !categoryFilter || (product.category_obj_id == categoryFilter) || (product.category_obj == categoryFilter);
            
            const matchesStock = !stockFilter || 
                (stockFilter === 'in_stock' && product.stock > 5) ||
                (stockFilter === 'low_stock' && product.stock > 0 && product.stock <= 5) ||
                (stockFilter === 'out_of_stock' && product.stock === 0);
            
            return matchesSearch && matchesCategory && matchesStock;
        });
        
        displayProducts(filteredProducts);
    }
    
    function handleAddProduct(event) {
        event.preventDefault();
        
        const formData = new FormData(event.target);
        
        fetch('/api/admin/products/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken
            },
            body: formData
        })
        .then(response => {
            // Instead of just checking if response is ok, let's handle all cases
            return response.json().then(data => {
                return { status: response.status, data: data };
            }).catch(() => {
                // If JSON parsing fails, return the status and empty data
                return { status: response.status, data: {} };
            });
        })
        .then(result => {
            const { status, data } = result;
            if (status >= 200 && status < 300) {
                // Success case
                if (data.id || data.message) {
                    showToast('Product added successfully', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('addProductModal')).hide();
                    loadProducts();
                    // Reset the form properly
                    document.getElementById('addProductForm').reset();
                    // Reset category select to default
                    document.getElementById('productCategory').selectedIndex = 0;
                } else {
                    showToast('Error adding product: ' + (data.error || 'Unknown error'), 'error');
                }
            } else {
                // Error case
                showToast('Error adding product: ' + (data.error || data.detail || 'Unknown error'), 'error');
            }
        })
        .catch(error => {
            console.error('Error adding product:', error);
            showToast('Error adding product: ' + error.message, 'error');
        });
    }
    
    function editProduct(productId) {
        const product = currentProducts.find(p => p.id === productId);
        if (!product) return;
        
        // Populate edit form
        document.getElementById('editProductId').value = product.id;
        document.getElementById('editProductName').value = product.name;
        // Use category_obj ID (either category_obj_id for DRF or category_obj for non-DRF)
        document.getElementById('editProductCategory').value = product.category_obj_id || product.category_obj || '';
        document.getElementById('editProductPrice').value = product.price;
        document.getElementById('editProductStock').value = product.stock;  // This should be a number
        document.getElementById('editProductDescription').value = product.description || '';
        document.getElementById('editProductActive').checked = product.is_available;  // Use is_available instead of is_active
        // is_featured checkbox
        const featuredCheckbox = document.getElementById('editProductFeatured');
        if (featuredCheckbox) {
            featuredCheckbox.checked = product.is_featured;
        }
        
        // Show modal
        new bootstrap.Modal(document.getElementById('editProductModal')).show();
    }
    
    function handleEditProduct(event) {
        event.preventDefault();
        
        const formData = new FormData(event.target);
        const productId = formData.get('id');
        
        // For editing, we need to send the data differently to handle file uploads
        fetch(`/api/admin/products/${productId}/`, {
            method: 'PUT',
            headers: {
                'X-CSRFToken': csrftoken
            },
            body: formData
        })
        .then(response => {
            // Instead of just checking if response is ok, let's handle all cases
            return response.json().then(data => {
                return { status: response.status, data: data };
            }).catch(() => {
                // If JSON parsing fails, return the status and empty data
                return { status: response.status, data: {} };
            });
        })
        .then(result => {
            const { status, data } = result;
            if (status >= 200 && status < 300) {
                // Success case
                if (data.id || data.message) {
                    showToast('Product updated successfully', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('editProductModal')).hide();
                    loadProducts();
                } else {
                    showToast('Error updating product: ' + (data.error || 'Unknown error'), 'error');
                }
            } else {
                // Error case
                showToast('Error updating product: ' + (data.error || data.detail || 'Unknown error'), 'error');
            }
        })
        .catch(error => {
            console.error('Error updating product:', error);
            showToast('Error updating product: ' + error.message, 'error');
        });
    }
    
    function confirmDeleteProduct(productId, productName) {
        document.getElementById('deleteProductName').textContent = productName;
        document.getElementById('confirmDeleteBtn').setAttribute('data-product-id', productId);
        new bootstrap.Modal(document.getElementById('deleteProductModal')).show();
    }
    
    function handleDeleteProduct() {
        const productId = document.getElementById('confirmDeleteBtn').getAttribute('data-product-id');
        
        fetch(`/api/admin/products/${productId}/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': csrftoken
            }
        })
        .then(response => {
            // Instead of just checking if response is ok, let's handle all cases
            return response.json().then(data => {
                return { status: response.status, data: data };
            }).catch(() => {
                // If JSON parsing fails, return the status and empty data
                return { status: response.status, data: {} };
            });
        })
        .then(result => {
            const { status, data } = result;
            if (status >= 200 && status < 300) {
                // Success case
                if (data.message) {
                    showToast('Product deleted successfully', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('deleteProductModal')).hide();
                    loadProducts();
                } else {
                    showToast('Error deleting product: ' + (data.error || 'Unknown error'), 'error');
                }
            } else {
                // Error case
                showToast('Error deleting product: ' + (data.error || data.detail || 'Unknown error'), 'error');
            }
        })
        .catch(error => {
            console.error('Error deleting product:', error);
            showToast('Error deleting product: ' + error.message, 'error');
        });
    }
</script>
{% endblock %}