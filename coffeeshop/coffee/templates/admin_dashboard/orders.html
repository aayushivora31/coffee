{% extends 'admin_dashboard/base.html' %}

{% block content %}
<!-- Page Header -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="h3 mb-0">Order Management</h2>
    <div class="btn-group" role="group">
        <button class="btn btn-outline-primary" onclick="refreshOrders()">
            <i class="bi bi-arrow-clockwise me-1"></i>Refresh
        </button>
        <button class="btn btn-outline-success" onclick="exportOrders()">
            <i class="bi bi-download me-1"></i>Export
        </button>
    </div>
</div>

<!-- Order Statistics -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-white bg-warning">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title">Pending Orders</h6>
                        <h2 class="mb-0" id="pendingOrdersCount">0</h2>
                    </div>
                    <div class="align-self-center">
                        <i class="bi bi-clock-history fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card text-white bg-info">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title">Processing</h6>
                        <h2 class="mb-0" id="processingOrdersCount">0</h2>
                    </div>
                    <div class="align-self-center">
                        <i class="bi bi-gear-fill fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card text-white bg-success">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title">Completed</h6>
                        <h2 class="mb-0" id="completedOrdersCount">0</h2>
                    </div>
                    <div class="align-self-center">
                        <i class="bi bi-check-circle-fill fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card text-white bg-danger">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title">Cancelled</h6>
                        <h2 class="mb-0" id="cancelledOrdersCount">0</h2>
                    </div>
                    <div class="align-self-center">
                        <i class="bi bi-x-circle-fill fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Filters and Search -->
<div class="card mb-4">
    <div class="card-body">
        <div class="row g-3">
            <div class="col-md-3">
                <label for="searchOrder" class="form-label">Search Orders</label>
                <input type="text" class="form-control" id="searchOrder" placeholder="Order ID or customer name...">
            </div>
            <div class="col-md-2">
                <label for="statusFilter" class="form-label">Status</label>
                <select class="form-select" id="statusFilter">
                    <option value="">All Status</option>
                    <option value="pending">Pending</option>
                    <option value="confirmed">Confirmed</option>
                    <option value="preparing">Preparing</option>
                    <option value="ready">Ready</option>
                    <option value="delivered">Delivered</option>
                    <option value="cancelled">Cancelled</option>
                </select>
            </div>
            <div class="col-md-2">
                <label for="dateFrom" class="form-label">From Date</label>
                <input type="date" class="form-control" id="dateFrom">
            </div>
            <div class="col-md-2">
                <label for="dateTo" class="form-label">To Date</label>
                <input type="date" class="form-control" id="dateTo">
            </div>
            <div class="col-md-2">
                <label for="minAmount" class="form-label">Min Amount (â‚¹)</label>
                <input type="number" class="form-control" id="minAmount" min="0">
            </div>
            <div class="col-md-1">
                <label class="form-label">&nbsp;</label>
                <button class="btn btn-primary d-block w-100" onclick="applyFilters()">
                    <i class="bi bi-funnel"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Orders Table -->
<div class="card">
    <div class="card-header">
        <h6 class="m-0 fw-bold text-primary">All Orders</h6>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover" id="ordersTable">
                <thead>
                    <tr>
                        <th>Order ID</th>
                        <th>Customer</th>
                        <th>Items</th>
                        <th>Total</th>
                        <th>Status</th>
                        <th>Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="ordersTableBody">
                    <tr>
                        <td colspan="7" class="text-center">
                            <div class="loading">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <!-- Pagination -->
        <nav aria-label="Orders pagination" class="mt-3">
            <ul class="pagination justify-content-center" id="ordersPagination">
                <!-- Pagination will be populated by JavaScript -->
            </ul>
        </nav>
    </div>
</div>

<!-- Order Details Modal -->
<div class="modal fade" id="orderDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Order Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="orderDetailsContent">
                <!-- Order details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-coffee" id="updateOrderStatusBtn">Update Status</button>
            </div>
        </div>
    </div>
</div>

<!-- Update Status Modal -->
<div class="modal fade" id="updateStatusModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Update Order Status</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="updateStatusForm">
                <div class="modal-body">
                    <input type="hidden" id="updateOrderId" name="order_id">
                    
                    <div class="mb-3">
                        <label for="newStatus" class="form-label">New Status</label>
                        <select class="form-select" id="newStatus" name="status" required>
                            <option value="">Select Status</option>
                            <option value="pending">Pending</option>
                            <option value="confirmed">Confirmed</option>
                            <option value="preparing">Preparing</option>
                            <option value="ready">Ready</option>
                            <option value="delivered">Delivered</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="statusNote" class="form-label">Note (Optional)</label>
                        <textarea class="form-control" id="statusNote" name="note" rows="3" placeholder="Add a note about this status change..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-coffee">Update Status</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let currentOrders = [];
    let currentPage = 1;
    let totalPages = 1;
    
    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
        loadOrderStats();
        loadOrders();
        setupEventListeners();
        setDefaultDates();
    });
    
    function setDefaultDates() {
        const today = new Date();
        const lastWeek = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
        
        document.getElementById('dateFrom').value = lastWeek.toISOString().split('T')[0];
        document.getElementById('dateTo').value = today.toISOString().split('T')[0];
    }
    
    function loadOrderStats() {
        fetch('/api/admin/orders/stats/')
            .then(response => response.json())
            .then(data => {
                document.getElementById('pendingOrdersCount').textContent = data.pending || 0;
                document.getElementById('processingOrdersCount').textContent = (data.confirmed || 0) + (data.preparing || 0);
                document.getElementById('completedOrdersCount').textContent = data.delivered || 0;
                document.getElementById('cancelledOrdersCount').textContent = data.cancelled || 0;
            })
            .catch(error => {
                console.error('Error loading order stats:', error);
            });
    }
    
    function loadOrders(page = 1) {
        const params = new URLSearchParams({
            page: page,
            search: document.getElementById('searchOrder').value,
            status: document.getElementById('statusFilter').value,
            date_from: document.getElementById('dateFrom').value,
            date_to: document.getElementById('dateTo').value,
            min_amount: document.getElementById('minAmount').value
        });
        
        fetch(`/api/admin/orders/?${params}`)
            .then(response => response.json())
            .then(data => {
                currentOrders = data.results || data;
                currentPage = page;
                totalPages = Math.ceil((data.count || data.length) / 20);
                
                displayOrders(currentOrders);
                updatePagination();
            })
            .catch(error => {
                console.error('Error loading orders:', error);
                showToast('Error loading orders', 'error');
            });
    }
    
    function displayOrders(orders) {
        const tbody = document.getElementById('ordersTableBody');
        
        if (orders.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No orders found</td></tr>';
            return;
        }
        
        tbody.innerHTML = orders.map(order => `
            <tr>
                <td>
                    <small class="font-monospace">#${order.order_id ? order.order_id.substring(0, 8) : order.id}</small>
                </td>
                <td>
                    <strong>${order.customer_name || order.user?.username || 'Guest'}</strong>
                    ${order.customer_email ? `<br><small class="text-muted">${order.customer_email}</small>` : ''}
                </td>
                <td>
                    <small>${order.items_count || order.items?.length || 0} items</small>
                    ${order.items && order.items.length > 0 ? 
                        `<br><small class="text-muted">${order.items.slice(0, 2).map(item => item.menu_item_name || item.name).join(', ')}${order.items.length > 2 ? '...' : ''}</small>` : 
                        ''
                    }
                </td>
                <td>
                    <strong>â‚¹${Number(order.total_amount || order.total || 0).toLocaleString('en-IN')}</strong>
                </td>
                <td>
                    <span class="badge bg-${getStatusColor(order.status)}">
                        ${getStatusDisplay(order.status)}
                    </span>
                </td>
                <td>
                    <small>${new Date(order.created_at).toLocaleDateString('en-IN')}</small>
                    <br><small class="text-muted">${new Date(order.created_at).toLocaleTimeString('en-IN', {hour: '2-digit', minute: '2-digit'})}</small>
                </td>
                <td>
                    <div class="btn-group" role="group">
                        <button class="btn btn-sm btn-outline-primary" onclick="viewOrderDetails(${order.id})" title="View Details">
                            <i class="bi bi-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-warning" onclick="updateOrderStatus(${order.id}, '${order.status}')" title="Update Status">
                            <i class="bi bi-pencil"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `).join('');
    }
    
    function getStatusColor(status) {
        const colors = {
            'pending': 'warning',
            'confirmed': 'info',
            'preparing': 'primary',
            'ready': 'success',
            'delivered': 'success',
            'cancelled': 'danger'
        };
        return colors[status] || 'secondary';
    }
    
    function getStatusDisplay(status) {
        const displays = {
            'pending': 'Pending',
            'confirmed': 'Confirmed',
            'preparing': 'Preparing',
            'ready': 'Ready',
            'delivered': 'Delivered',
            'cancelled': 'Cancelled'
        };
        return displays[status] || status;
    }
    
    function updatePagination() {
        const pagination = document.getElementById('ordersPagination');
        
        if (totalPages <= 1) {
            pagination.innerHTML = '';
            return;
        }
        
        let paginationHTML = '';
        
        // Previous page
        paginationHTML += `
            <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="loadOrders(${currentPage - 1})">Previous</a>
            </li>
        `;
        
        // Page numbers
        for (let i = Math.max(1, currentPage - 2); i <= Math.min(totalPages, currentPage + 2); i++) {
            paginationHTML += `
                <li class="page-item ${i === currentPage ? 'active' : ''}">
                    <a class="page-link" href="#" onclick="loadOrders(${i})">${i}</a>
                </li>
            `;
        }
        
        // Next page
        paginationHTML += `
            <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="loadOrders(${currentPage + 1})">Next</a>
            </li>
        `;
        
        pagination.innerHTML = paginationHTML;
    }
    
    function setupEventListeners() {
        // Search functionality
        document.getElementById('searchOrder').addEventListener('input', function() {
            clearTimeout(this.searchTimeout);
            this.searchTimeout = setTimeout(() => applyFilters(), 500);
        });
        
        // Status update form
        document.getElementById('updateStatusForm').addEventListener('submit', handleStatusUpdate);
    }
    
    function applyFilters() {
        currentPage = 1;
        loadOrders(1);
    }
    
    function refreshOrders() {
        loadOrderStats();
        loadOrders(currentPage);
        showToast('Orders refreshed', 'success');
    }
    
    function exportOrders() {
        const params = new URLSearchParams({
            format: 'csv',
            search: document.getElementById('searchOrder').value,
            status: document.getElementById('statusFilter').value,
            date_from: document.getElementById('dateFrom').value,
            date_to: document.getElementById('dateTo').value,
            min_amount: document.getElementById('minAmount').value
        });
        
        window.open(`/api/admin/orders/export/?${params}`, '_blank');
    }
    
    function viewOrderDetails(orderId) {
        fetch(`/api/admin/orders/${orderId}/`)
            .then(response => response.json())
            .then(order => {
                const content = document.getElementById('orderDetailsContent');
                content.innerHTML = `
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Order Information</h6>
                            <table class="table table-borderless table-sm">
                                <tr><td><strong>Order ID:</strong></td><td>#${order.order_id || order.id}</td></tr>
                                <tr><td><strong>Status:</strong></td><td><span class="badge bg-${getStatusColor(order.status)}">${getStatusDisplay(order.status)}</span></td></tr>
                                <tr><td><strong>Date:</strong></td><td>${new Date(order.created_at).toLocaleDateString('en-IN')} ${new Date(order.created_at).toLocaleTimeString('en-IN')}</td></tr>
                                <tr><td><strong>Total:</strong></td><td><strong>â‚¹${Number(order.total_amount || order.total).toLocaleString('en-IN')}</strong></td></tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h6>Customer Information</h6>
                            <table class="table table-borderless table-sm">
                                <tr><td><strong>Name:</strong></td><td>${order.customer_name || order.user?.username || 'Guest'}</td></tr>
                                <tr><td><strong>Email:</strong></td><td>${order.customer_email || order.user?.email || 'N/A'}</td></tr>
                                <tr><td><strong>Phone:</strong></td><td>${order.customer_phone || 'N/A'}</td></tr>
                                <tr><td><strong>Address:</strong></td><td>${order.delivery_address || 'N/A'}</td></tr>
                            </table>
                        </div>
                    </div>
                    
                    <hr>
                    
                    <h6>Order Items</h6>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th>Price</th>
                                    <th>Quantity</th>
                                    <th>Subtotal</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${order.items ? order.items.map(item => `
                                    <tr>
                                        <td>${item.menu_item_name || item.name}</td>
                                        <td>â‚¹${Number(item.price).toLocaleString('en-IN')}</td>
                                        <td>${item.quantity}</td>
                                        <td>â‚¹${Number(item.subtotal || (item.price * item.quantity)).toLocaleString('en-IN')}</td>
                                    </tr>
                                `).join('') : '<tr><td colspan="4" class="text-center">No items found</td></tr>'}
                            </tbody>
                        </table>
                    </div>
                `;
                
                document.getElementById('updateOrderStatusBtn').setAttribute('data-order-id', orderId);
                document.getElementById('updateOrderStatusBtn').setAttribute('data-current-status', order.status);
                
                new bootstrap.Modal(document.getElementById('orderDetailsModal')).show();
            })
            .catch(error => {
                console.error('Error loading order details:', error);
                showToast('Error loading order details', 'error');
            });
    }
    
    function updateOrderStatus(orderId, currentStatus) {
        document.getElementById('updateOrderId').value = orderId;
        document.getElementById('newStatus').value = currentStatus;
        document.getElementById('statusNote').value = '';
        
        new bootstrap.Modal(document.getElementById('updateStatusModal')).show();
    }
    
    function handleStatusUpdate(event) {
        event.preventDefault();
        
        const formData = new FormData(event.target);
        const orderId = formData.get('order_id');
        
        fetch(`/api/admin/orders/${orderId}/update-status/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                status: formData.get('status'),
                note: formData.get('note')
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('Order status updated successfully', 'success');
                bootstrap.Modal.getInstance(document.getElementById('updateStatusModal')).hide();
                loadOrders(currentPage);
                loadOrderStats();
            } else {
                showToast('Error updating order status', 'error');
            }
        })
        .catch(error => {
            console.error('Error updating order status:', error);
            showToast('Error updating order status', 'error');
        });
    }
    
    // Event listener for update status button in order details modal
    document.getElementById('updateOrderStatusBtn').addEventListener('click', function() {
        const orderId = this.getAttribute('data-order-id');
        const currentStatus = this.getAttribute('data-current-status');
        
        bootstrap.Modal.getInstance(document.getElementById('orderDetailsModal')).hide();
        setTimeout(() => {
            updateOrderStatus(orderId, currentStatus);
        }, 500);
    });
</script>
{% endblock %}